<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ccxt/4.5.0/ccxt.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0b0f19;--card:#111729;--text:#e6edf3;--muted:#9fb3c8;--up:#12d18e;--down:#ff5d5d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex; flex-direction:column; align-items:center; gap:16px; padding:16px;
    }
    h1{margin:0; font-size:28px; letter-spacing:0.6px; text-align:center}
    .subtitle{color:var(--muted); font-size:14px; margin-top:4px; text-align:center}
    .board{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; width:100%; max-width:600px}
    .card{
      background:var(--card);
      border-radius:12px; padding:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .symbol{font-weight:700; font-size:18px}
    .price{font-weight:800; font-size:22px; margin:6px 0 2px; line-height:1}
    .row{display:flex; align-items:baseline; justify-content:space-between; font-size:12px}
    .muted{color:var(--muted)}
    .change{font-size:14px; font-weight:700}
    .change.up{color:var(--up)}
    .change.down{color:var(--down)}
    .chart-container{height:80px; margin-top:6px;}
    .footer{color:var(--muted); font-size:12px; margin-top:8px}
  </style>
</head>
<body>
  <main class="board" id="board"></main>
  <div class="footer" id="footer">—</div>

  <script>
    const SYMBOLS = ['SUI/USDT', 'ARB/USDT', 'ETH/USDT', 'PEPE/USDT', 'NEAR/USDT', 'ADA/USDT', 'DOGE/USDT'];
    const board = document.getElementById('board');
    const cards = {};
    const charts = {};

    function formatNumber(x){
      if (!x || isNaN(x)) return '-';
      const abs = Math.abs(x);
      const dp = abs >= 100 ? 2 : abs >= 1 ? 4 : 8;
      return Number(x).toLocaleString('en-US', { maximumFractionDigits: dp, minimumFractionDigits: Math.min(2, dp) });
    }

    function makeCard(symbol){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="row">
          <div class="symbol">${symbol.replace('/USDT','')}<span class="muted">/USDT</span></div>
          <div class="change muted" id="chg-${symbol}">--</div>
        </div>
        <div class="price" id="px-${symbol}">--</div>
        <div class="chart-container">
          <canvas id="chart-${symbol}"></canvas>
        </div>
      `;
      board.appendChild(el);
      cards[symbol] = el;
    }

    SYMBOLS.forEach(makeCard);

    const exchange = new ccxt.binance({ enableRateLimit: true });
    let lastPrices = {};

    async function fetchChartData(symbol) {
      try {
        const ohlcv = await exchange.fetchOHLCV(symbol, '1m', undefined, 30);
        const labels = ohlcv.map(c => {
          const d = new Date(c[0]);
          return d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
        });
        const prices = ohlcv.map(c => c[4]); // close
        return { labels, prices };
      } catch (err) {
        console.error('Lỗi lấy dữ liệu chart', symbol, err);
        return { labels: [], prices: [] };
      }
    }

    async function updateCard(symbol, ticker) {
      const px = ticker.last ?? ticker.close ?? ticker.bid ?? ticker.ask;
      const prev = lastPrices[symbol];
      document.getElementById(`px-${symbol}`).textContent = formatNumber(px);

      let changePct;
      if (ticker.open) changePct = ((px - ticker.open) / ticker.open) * 100;
      else if (prev) changePct = ((px - prev) / prev) * 100;
      if (changePct !== undefined){
        const sign = changePct >= 0 ? '+' : '';
        document.getElementById(`chg-${symbol}`).textContent = sign + changePct.toFixed(2) + '%';
        document.getElementById(`chg-${symbol}`).className = 'change ' + (changePct >= 0 ? 'up' : 'down');
      }

      lastPrices[symbol] = px;

      // Chart
      const { labels, prices } = await fetchChartData(symbol);
      if (!charts[symbol]) {
        const ctx = document.getElementById(`chart-${symbol}`).getContext('2d');
        charts[symbol] = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              data: prices,
              borderColor: '#12d18e',
              backgroundColor: 'rgba(18,209,142,0.1)',
              tension: 0.3,
              borderWidth: 1,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
      } else {
        charts[symbol].data.labels = labels;
        charts[symbol].data.datasets[0].data = prices;
        charts[symbol].update();
      }
    }

    async function fetchAll(){
      const now = new Date();
      const tickers = await Promise.allSettled(SYMBOLS.map(s => exchange.fetchTicker(s)));

      for (let i = 0; i < SYMBOLS.length; i++) {
        const symbol = SYMBOLS[i];
        if (tickers[i].status === 'fulfilled') {
          await updateCard(symbol, tickers[i].value);
        } else {
          document.getElementById(`px-${symbol}`).textContent = 'Lỗi';
          document.getElementById(`chg-${symbol}`).textContent = '--';
          document.getElementById(`chg-${symbol}`).className = 'change muted';
        }
      }

      document.getElementById('footer').textContent = 'Lần cập nhật: ' + now.toLocaleString();
    }

    (async ()=>{
      await exchange.loadMarkets();
      await fetchAll();
      setInterval(fetchAll, 5000);
    })();
  </script>
</body>
</html>
